<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HSAPSS Windsor</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    type="text/css"
    href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />

  <!-- Chart.js (Added for Chart.js status breakdown) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-color: #5d5bf0;
      --secondary-color: #f3f4f6;
      --accent-color: #ef4444;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --dark-text-color: #1f2937;
      --light-text-color: #fff;
      --card-bg: #ffffff;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.07);
      --body-font: 'Inter', sans-serif;
    }

    body {
      font-family: var(--body-font);
      background: var(--secondary-color);
      color: var(--dark-text-color);
      margin: 0;
      padding-bottom: 2rem;
    }

    /* ===================== HEADER / HERO ===================== */
    .page-header {
      position: relative;
      background: linear-gradient(
        45deg,
        var(--primary-color),
        #7a7ff0
      );
      color: var(--light-text-color);
      padding: 4rem 0 6rem;
      border-radius: 0 0 2rem 2rem;
      box-shadow: 0 20px 30px rgba(93,91,240,0.3);
      margin-bottom: 3rem;
      overflow: hidden;
    }

    /* Wave effect */
    .page-header::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 100px;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 1440 320' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23ffffff' fill-opacity='1' d='M0,320L60,288C120,256,240,192,360,176C480,160,600,192,720,176C840,160,960,96,1080,69.3C1200,43,1320,53,1380,58.7L1440,64L1440,0L1380,0C1320,0,1200,0,1080,0C960,0,840,0,720,0C600,0,480,0,360,0C240,0,120,0,60,0L0,0Z'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-size: cover;
      z-index: 1;
    }

    .page-header h1 {
      position: relative;
      z-index: 2;
      font-weight: 800;
      text-shadow: 0 3px 8px rgba(0,0,0,0.2);
      letter-spacing: 1px;
    }

    /* ===================== CARDS ===================== */
    .card {
      border: none;
      border-radius: 1rem;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease-in-out;
      position: relative;
      z-index: 10;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 20px rgba(0,0,0,0.1);
    }

    .card-header {
      border-radius: 1rem 1rem 0 0 !important;
      padding: 1rem 1.5rem;
      background: linear-gradient(
        to right,
        var(--primary-color),
        #7a7ff0
      );
      color: var(--light-text-color);
      font-weight: 600;
    }

    /* ===================== BUTTONS ===================== */
    .btn {
      border-radius: 0.75rem;
      padding: 0.5rem 1.2rem;
      font-weight: 500;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn i {
      margin-right: 6px;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    /* Gradient button variants */
    .btn-primary {
      background: linear-gradient(to right, #60c657, #35aee2);
      color: #fff;
    }
    .btn-info {
      background: linear-gradient(to right, #43cea2, #185a9d);
      color: #fff;
    }
    .btn-warning {
      background: linear-gradient(to right, #f9d423, #ff4e50);
      color: #fff;
    }
    .btn-success {
      background: linear-gradient(to right, #00b09b, #96c93d);
      color: #fff;
    }
    .btn-danger {
      background: linear-gradient(to right, #ff512f, #dd2476);
      color: #fff;
    }
    .btn-secondary {
      background: #4b5563;
      color: #fff;
    }

    /* Action Dropdown */
    .btn-group .dropdown-menu {
      border-radius: 0.5rem;
      border: none;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .btn-group .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-group .dropdown-item i {
      margin-right: 0;
    }

    /* ===================== FORM CONTROLS ===================== */
    .form-control {
      border-radius: 0.5rem;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    .form-control:focus {
      border-color: var(--info-color);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
    }

    /* ===================== DATATABLES ===================== */
    .dataTables_wrapper {
      padding: 1.5rem;
      background: #fff;
      border-radius: 1rem;
      box-shadow: var(--card-shadow);
      margin-top: 1rem;
      position: relative;
      z-index: 10;
    }
    table.dataTable {
      border-collapse: separate !important;
      border-spacing: 0;
      width: 100% !important;
    }
    .table > :not(caption) > * > * {
      padding: 1rem 1.5rem;
      vertical-align: middle;
    }
    .dataTable thead tr {
      background: #f9fafb;
    }
    .dataTable thead th {
      font-weight: 600;
      border-bottom: 2px solid #e2e8f0;
    }

    /* ===================== MODALS ===================== */
    .modal-content {
      border-radius: 1rem;
      border: none;
      overflow: hidden;
      box-shadow: 0 15px 32px rgba(0,0,0,0.1);
    }
    .modal-header .btn-close {
      filter: invert(1);
    }
    .modal-header.bg-primary,
    .modal-header.bg-info,
    .modal-header.bg-warning {
      color: var(--light-text-color);
    }
    .delete-confirm-modal .modal-header {
      background: linear-gradient(to right, #ff512f, #dd2476);
      color: #fff;
    }
    .delete-confirm-modal .modal-content {
      box-shadow: 0 10px 25px rgba(239,68,68,0.2);
    }
    .delete-confirm-modal .modal-body {
      padding: 2rem;
    }

    .delete-icon {
      font-size: 3rem;
      color: var(--accent-color);
      margin-bottom: 1rem;
    }

    /* ===================== PROGRESS BAR ===================== */
    .progress {
      height: 0.75rem;
      border-radius: 1rem;
      background-color: #e2e8f0;
      overflow: hidden;
    }
    .progress-bar {
      background-color: var(--success-color);
      border-radius: 1rem;
    }

    /* ===================== STATS CARD ===================== */
    .stats-card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
      transition: all 0.3s ease;
      position: relative;
      z-index: 10;
    }
    .stats-card:hover {
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    /* ===================== ANIMATIONS ===================== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(1rem);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fade-in {
      animation: fadeInUp 0.5s ease-out;
    }

    /* ===================== CALL STATUS STYLES ===================== */
    .called-today {
      color: #059669;
      font-weight: bold;
    }
    .called-this-week {
      color: #047857;
    }
    .not-called {
      color: var(--accent-color);
      font-weight: bold;
    }

    /* ===================== RESPONSIVE ADJUSTMENTS ===================== */
    @media (max-width: 767px) {
      .page-header {
        border-radius: 0;
      }
      .modal-content {
        border-radius: 0.5rem;
      }
      .btn {
        font-size: 0.9rem;
        padding: 0.45rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Page Header -->
  <div class="page-header">
    <div class="container text-center">
      <h1 class="mb-0">
        <i class="fas fa-users me-2"></i> HSAPSS Windsor
      </h1>
    </div>
  </div>

  <div class="container">
    <!-- Add Student Form -->
    <div class="card mb-4 shadow animate-fade-in">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-user-plus me-2"></i>Add New Yuvak
        </h5>
      </div>
      <div class="card-body">
        <form class="row g-3" id="addStudentForm">
          <div class="col-md-6 col-lg-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-user"></i></span>
              <input
                class="form-control"
                type="text"
                name="first_name"
                placeholder="First Name"
                required
              />
            </div>
          </div>
          <div class="col-md-6 col-lg-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-user"></i></span>
              <input
                class="form-control"
                type="text"
                name="last_name"
                placeholder="Last Name"
                required
              />
            </div>
          </div>
          <div class="col-md-6 col-lg-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-envelope"></i></span>
              <input
                class="form-control"
                type="email"
                name="mail_id"
                placeholder="Email"
                required
              />
            </div>
          </div>
          <div class="col-md-6 col-lg-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-phone"></i></span>
              <input
                class="form-control"
                type="text"
                name="phone"
                placeholder="Phone"
                required
              />
            </div>
          </div>
          <div class="col-md-6 col-lg-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
              <input
                class="form-control"
                type="text"
                name="address"
                placeholder="Address"
              />
            </div>
          </div>
          <div class="col-md-6 col-lg-4 d-grid">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-plus-circle"></i>Add Student
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Weekly Progress Stats -->
    <div class="stats-card animate-fade-in mb-4">
      <h5 class="mb-3">Weekly Calling Progress</h5>
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="progress mb-2">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
              id="weeklyProgress"
            >
              0%
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <span class="badge bg-success" id="callsCompleted">0</span> /
          <span class="badge bg-secondary" id="totalStudents">0</span> Called
        </div>
      </div>
    </div>

    <!-- Added for Chart.js status breakdown -->
    <div class="card mb-4 shadow animate-fade-in" id="callStatusCard">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-chart-pie me-2"></i>Call Status Distribution
        </h5>
      </div>
      <div class="card-body">
        <canvas id="callStatusChart" width="400" height="200"></canvas>
      </div>
    </div>
    <!-- End Chart.js status breakdown card -->

    <!-- Students Table -->
    <div class="table-responsive">
      <table
        id="studentsTable"
        class="display table table-striped table-bordered nowrap"
        style="width: 100%"
      >
        <thead>
          <tr>
            <th>ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Last Called</th>
            <th>Call Status</th>
            <th>Address</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Call Log Modal -->
  <div class="modal fade" id="callLogModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-phone me-2"></i>Log Call
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="callLogForm">
          <div class="modal-body">
            <input type="hidden" id="callStudentId" />
            <div class="mb-3">
              <label class="form-label">Call Status</label>
              <select class="form-select" id="callStatus" required>
                <option value="completed">Completed</option>
                <option value="no-answer">No Answer</option>
                <option value="voicemail">Left Voicemail</option>
                <option value="wrong-number">Wrong Number</option>
                <option value="disconnected">Disconnected</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea
                class="form-control"
                id="callNotes"
                rows="3"
                placeholder="Enter call details..."
              ></textarea>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="needsFollowUp"
                />
                <label class="form-check-label" for="needsFollowUp">Needs Follow-up</label>
              </div>
            </div>
            <div class="mb-3" id="followUpDateContainer" style="display: none;">
              <label class="form-label">Follow-up Date</label>
              <input type="date" class="form-control" id="followUpDate" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times"></i>Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check"></i>Save Call Log
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Call History Modal -->
  <div class="modal fade" id="callHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">
            <i class="fas fa-history me-2"></i>Call History
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="callHistoryContent">
          <!-- Call history items will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title text-white">
            <i class="fas fa-edit me-2"></i>Edit Yuvak
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editStudentForm">
          <div class="modal-body">
            <input type="hidden" id="editStudentId" />
            <div class="mb-3">
              <label class="form-label">First Name</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input
                  type="text"
                  id="editFirstName"
                  class="form-control"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Last Name</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input
                  type="text"
                  id="editLastName"
                  class="form-control"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                <input
                  type="email"
                  id="editMailId"
                  class="form-control"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                <input
                  type="text"
                  id="editPhone"
                  class="form-control"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Address</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                <input
                  type="text"
                  id="editAddress"
                  class="form-control"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times"></i>Cancel
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i>Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade delete-confirm-modal" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-white">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body text-center">
          <i class="fas fa-user-times delete-icon"></i>
          <h5 class="mb-3">Are you sure you want to delete this yuvak?</h5>
          <p class="text-muted mb-4">This action cannot be undone.</p>
          <input type="hidden" id="deleteStudentId" />
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">
            <i class="fas fa-trash me-1"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery, DataTables, Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    let dataTable;
    let callStatusChart; // Reference to our Chart.js instance

    // Unified call log storage object
    const callHistory = {
      logs: {},
      addLog(studentId, log) {
        if (!this.logs[studentId]) {
          this.logs[studentId] = [];
        }
        const newLog = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          status: log.status,
          notes: log.notes,
          needsFollowUp: log.needsFollowUp,
          followUpDate: log.followUpDate
        };
        this.logs[studentId].unshift(newLog);
        this.saveToStorage();
        this.updateStats();
        updateStatusChart(); // <--- Update the chart whenever a new call is logged
        return newLog;
      },
      getLogsForStudent(studentId) {
        return this.logs[studentId] || [];
      },
      getLastCall(studentId) {
        return this.logs[studentId]?.[0] || null;
      },
      getWeeklyStats() {
        const totalStudents = dataTable ? dataTable.rows().count() : 0;
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);

        const calledThisWeek = Object.values(this.logs).filter(logs => {
          const lastCall = logs[0];
          if (!lastCall) return false;
          const lastCallDate = new Date(lastCall.timestamp);
          return lastCallDate > weekAgo;
        }).length;

        return {
          totalStudents,
          calledThisWeek,
          progress: (calledThisWeek / totalStudents) * 100 || 0
        };
      },
      updateStats() {
        const stats = this.getWeeklyStats();
        const progress = Math.round(stats.progress);
        document.getElementById('weeklyProgress').style.width = progress + '%';
        document.getElementById('weeklyProgress').textContent = progress + '%';
        document.getElementById('callsCompleted').textContent = stats.calledThisWeek;
        document.getElementById('totalStudents').textContent = stats.totalStudents;
      },
      saveToStorage() {
        localStorage.setItem('callHistory', JSON.stringify(this.logs));
      },
      loadFromStorage() {
        const saved = localStorage.getItem('callHistory');
        if (saved) {
          this.logs = JSON.parse(saved);
        }
      },
      init() {
        this.loadFromStorage();
        if (dataTable) {
          this.updateStats();
        }
      }
    };

    $(document).ready(function() {
      dataTable = $('#studentsTable').DataTable({
        responsive: true,
        columns: [
          { data: 'student_index' },
          { data: 'first_name' },
          { data: 'last_name' },
          { data: 'mail_id' },
          { data: 'phone' },
          { data: 'lastCalled' },
          { data: 'callStatus' },
          { data: 'address' },
          { data: 'actions' }
        ],
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Search records..."
        }
      });

      callHistory.init();
      fetchStudents();

      dataTable.on('draw', function() {
        $('.dataTable tbody tr').addClass('animate-fade-in');
      });

      // Initialize Chart.js after the page loads
      initStatusChart();
      // Immediately update chart based on any existing localStorage data
      updateStatusChart();
    });

    // Initialize the Chart.js doughnut chart
    function initStatusChart() {
      const ctx = document.getElementById('callStatusChart').getContext('2d');
      callStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Completed','No Answer','Voicemail','Wrong Number','Disconnected'],
          datasets: [{
            label: 'Call Status',
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              '#22c55e', // completed
              '#f59e0b', // no-answer
              '#3b82f6', // voicemail
              '#ef4444', // wrong-number
              '#6b7280'  // disconnected
            ],
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Tally up the statuses from our callHistory.logs
    function updateStatusChart() {
      if (!callStatusChart) return;

      // Tally each status
      const statusCount = {
        completed: 0,
        'no-answer': 0,
        voicemail: 0,
        'wrong-number': 0,
        disconnected: 0
      };

      // Loop over each student's logs and increment counts
      Object.values(callHistory.logs).forEach(logs => {
        logs.forEach(item => {
          if (statusCount[item.status] !== undefined) {
            statusCount[item.status]++;
          }
        });
      });

      // Match these to the dataset order: completed, no-answer, voicemail, wrong-number, disconnected
      const newData = [
        statusCount['completed'],
        statusCount['no-answer'],
        statusCount['voicemail'],
        statusCount['wrong-number'],
        statusCount['disconnected']
      ];

      // Update chart dataset
      callStatusChart.data.datasets[0].data = newData;
      callStatusChart.update();
    }

    // Fetch students from /students
    async function fetchStudents() {
      try {
        const response = await fetch('/students');
        const students = await response.json();

        dataTable.clear();

        students.forEach(student => {
          const lastCall = callHistory.getLastCall(student.student_index);
          const lastCalledDate = lastCall
            ? new Date(lastCall.timestamp).toLocaleDateString()
            : 'Never';
          const callStatusObj = getCallStatus(lastCall);

          dataTable.row.add({
            student_index: student.student_index,
            first_name: student.first_name,
            last_name: student.last_name,
            mail_id: `
              <a href="mailto:${student.mail_id}" class="text-decoration-none">
                <i class="fas fa-envelope text-primary me-1"></i>${student.mail_id}
              </a>`,
            phone: `
              <a href="tel:${student.phone}" class="text-decoration-none">
                <i class="fas fa-phone text-primary me-1"></i>${student.phone}
              </a>`,
            lastCalled: lastCalledDate,
            callStatus: `
              <span class="call-status ${callStatusObj.class}">
                ${callStatusObj.text}
              </span>`,
            address: student.address
              ? `<i class="fas fa-map-marker-alt me-1"></i>${student.address}`
              : 'N/A',
            actions: actionDropdown(student)
          });
        });

        dataTable.draw();
        callHistory.updateStats();
        updateStatusChart(); // Re-draw chart in case data changed
      } catch (error) {
        console.error('Error fetching students:', error);
      }
    }

    // Determine call status style
    function getCallStatus(lastCall) {
      if (!lastCall) {
        return { class: 'not-called', text: 'Not Called' };
      }
      const lastCallDate = new Date(lastCall.timestamp);
      const today = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);

      if (lastCallDate.toDateString() === today.toDateString()) {
        return { class: 'called-today', text: 'Called Today' };
      } else if (lastCallDate > weekAgo) {
        return { class: 'called-this-week', text: 'Called This Week' };
      } else {
        return { class: 'not-called', text: 'Need to Call' };
      }
    }

    // Create a dropdown for actions
    function actionDropdown(student) {
      return `
        <div class="btn-group">
          <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Actions
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" onclick="showCallModal(${student.student_index})">
                <i class="fas fa-phone"></i> Log Call
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#" onclick="showCallHistory(${student.student_index})">
                <i class="fas fa-history"></i> History
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#"
                onclick="showEditModal(
                  ${student.student_index},
                  '${student.first_name}',
                  '${student.last_name}',
                  '${student.mail_id}',
                  '${student.phone}',
                  '${student.address || ''}'
                )"
              >
                <i class="fas fa-edit"></i> Edit
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#" onclick="deleteStudent(${student.student_index})">
                <i class="fas fa-trash"></i> Delete
              </a>
            </li>
          </ul>
        </div>
      `;
    }

    // Show Edit Modal
    function showEditModal(id, firstName, lastName, mailId, phone, address) {
      const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
      document.getElementById('editStudentId').value = id;
      document.getElementById('editFirstName').value = firstName;
      document.getElementById('editLastName').value = lastName;
      document.getElementById('editMailId').value = mailId;
      document.getElementById('editPhone').value = phone;
      document.getElementById('editAddress').value = address || '';
      modal.show();
    }

    // Add Student
    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        await fetch('/students', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        e.target.reset();
        fetchStudents();
      } catch (error) {
        console.error('Error adding student:', error);
      }
    });

    // Edit Student
    document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const id = document.getElementById('editStudentId').value;
        const data = {
          first_name: document.getElementById('editFirstName').value,
          last_name: document.getElementById('editLastName').value,
          mail_id: document.getElementById('editMailId').value,
          phone: document.getElementById('editPhone').value,
          address: document.getElementById('editAddress').value
        };

        await fetch(`/students/edit/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
        fetchStudents();
      } catch (error) {
        console.error('Error updating student:', error);
      }
    });

    // Delete Student
    function deleteStudent(id) {
      document.getElementById('deleteStudentId').value = id;
      const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      modal.show();
    }

    async function confirmDelete() {
      try {
        const id = document.getElementById('deleteStudentId').value;
        const response = await fetch(`/students/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Failed to delete student');
        }

        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        fetchStudents();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Failed to delete student. Please try again.');
      }
    }

    // Show Call Modal
    function showCallModal(studentId) {
      $('#callStudentId').val(studentId);
      $('#callStatus').val('completed');
      $('#callNotes').val('');
      $('#needsFollowUp').prop('checked', false);
      $('#followUpDateContainer').hide();

      const modal = new bootstrap.Modal(document.getElementById('callLogModal'));
      modal.show();
    }

    // Toggle follow-up date
    $('#needsFollowUp').on('change', function() {
      $('#followUpDateContainer').toggle(this.checked);
    });

    // Log Call
    $('#callLogForm').on('submit', function(e) {
      e.preventDefault();

      const studentId = $('#callStudentId').val();
      const log = {
        status: $('#callStatus').val(),
        notes: $('#callNotes').val(),
        needsFollowUp: $('#needsFollowUp').is(':checked'),
        followUpDate: $('#needsFollowUp').is(':checked')
          ? $('#followUpDate').val()
          : null
      };

      callHistory.addLog(studentId, log);
      bootstrap.Modal.getInstance(document.getElementById('callLogModal')).hide();
      fetchStudents();
    });

    // Show call history
    function showCallHistory(studentId) {
      const logs = callHistory.getLogsForStudent(studentId);
      let content = `
        <div class="call-logs-container">
          <div class="mb-3 border-bottom pb-2">
            <h6 class="mb-1">Call History</h6>
            <p class="text-muted mb-0 small">Showing all calls for this yuvak</p>
          </div>
      `;

      if (logs.length === 0) {
        content += `
          <div class="text-center py-4">
            <i class="fas fa-phone-slash fa-2x text-muted mb-2"></i>
            <p class="text-muted">No calls logged yet</p>
          </div>
        `;
      } else {
        logs.forEach(log => {
          const date = new Date(log.timestamp).toLocaleString();
          const statusColor = getStatusBadgeColor(log.status);

          content += `
            <div class="call-log-item mb-3 p-3 border rounded bg-light">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-${statusColor}">
                  ${formatCallStatus(log.status)}
                </span>
                <small class="text-muted">${date}</small>
              </div>
              ${
                log.notes
                  ? `<p class="mb-2 small">${log.notes}</p>`
                  : ''
              }
              ${
                log.needsFollowUp
                  ? `<div class="mt-2 small">
                      <i class="fas fa-calendar-alt text-warning me-1"></i>
                      Follow-up scheduled: ${new Date(log.followUpDate).toLocaleDateString()}
                    </div>`
                  : ''
              }
            </div>
          `;
        });
      }

      content += '</div>';

      $('#callHistoryContent').html(content);
      const modal = new bootstrap.Modal(document.getElementById('callHistoryModal'));
      modal.show();
    }

    // Status badge colors
    function getStatusBadgeColor(status) {
      const colors = {
        completed: 'success',
        'no-answer': 'warning',
        voicemail: 'info',
        'wrong-number': 'danger',
        disconnected: 'secondary'
      };
      return colors[status] || 'primary';
    }

    // Format call status text
    function formatCallStatus(status) {
      return status
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
  </script>
</body>
</html>
